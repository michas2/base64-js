<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Piping a fetch response to StreamSaver</title>
  </head>
  <body>
    <button id="$start">Start</button>
    <script src="https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/ponyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/StreamSaver.min.js"></script>
    <script src="base64.js"></script>
    <script>
      $start.onclick = () => {
	const file= 'random'
        const url = './'+file+'.64.gz'
        const fileStream = streamSaver.createWriteStream(file)

        fetch(url)
	.then(res => res.body)
	.then(stream => stream.pipeThrough(new DecompressionStream('gzip')))
	.then(stream => stream.pipeThrough(new TransformStream(new Base64Transformer())))
	.then(stream => stream.pipeTo(fileStream))
        .then(() => console.log('done writing'))
      }
    </script>
  </body>
</html>
